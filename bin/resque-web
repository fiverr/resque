#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path(File.dirname(__FILE__) + '/../lib')
begin
  require 'vegas'
rescue LoadError
  require 'rubygems'
  require 'vegas'
end  
require 'resque/server'


CREDENTIALS = ENV['AUTH']
if CREDENTIALS
  cred = credentials
else
  cred = "fiverr:fewf9wedvjew832D"
end

  Resque::Server.use Rack::Auth::Basic do |username, password|
    credentials = cred.split(':',2)
    if credentials.size == 2
      username, password = credentials[0], credentials[1]
    else
      password = credentials[0]
    end
  end

Vegas::Runner.new(Resque::Server, 'resque-web', {
  :before_run => lambda {|v|
    path = (ENV['RESQUECONFIG'] || v.args.first)
    load path.to_s.strip if path
  }
}) do |runner, opts, app|
  opts.on('-N NAMESPACE', "--namespace NAMESPACE", "set the Redis namespace") {|namespace|
    runner.logger.info "Using Redis namespace '#{namespace}'"
    Resque.redis.namespace = namespace
  }
end
